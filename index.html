<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Teacher Multi-Slide Whiteboard</title>
<style>
html, body { margin:0; padding:0; height:100%; overflow:hidden; }
#toolbar { position:absolute; top:10px; left:10px; z-index:1000; background:#fff; padding:5px; border-radius:5px; }
button, select { margin:5px; padding:5px; }
canvas { border:1px solid #ccc; }
</style>
</head>
<body>

<div id="toolbar">
  <!-- Pens -->
  <button onclick="setBrush('normal')">Normal Pen</button>
  <button onclick="setBrush('brush')">Brush</button>
  <button onclick="setBrush('fountain')">Fountain</button>
  <button onclick="setBrush('marker')">Marker</button>
  <button onclick="setBrush('highlighter')">Highlighter</button>

  <!-- Shapes -->
  <button onclick="addShape('rect')">Rectangle</button>
  <button onclick="addShape('circle')">Circle</button>
  <button onclick="addShape('line')">Line</button>
  <button onclick="addShape('dottedLine')">Dotted Line</button>
  <button onclick="addShape('triangle')">Triangle</button>

  <!-- Slides -->
  <button onclick="prevSlide()">Prev Slide</button>
  <button onclick="nextSlide()">Next Slide</button>
  <button onclick="saveSlide()">Save Slide</button>

  <!-- Upload -->
  <input type="file" id="uploadFile">

  <!-- Class & Subject -->
  <select id="classSelect">
    <option value="">Select Class</option>
    <option value="Class10">Class 10</option>
    <option value="Class11">Class 11</option>
    <option value="Class12">Class 12</option>
  </select>
  <select id="subjectSelect">
    <option value="">Select Subject</option>
    <option value="Physics">Physics</option>
    <option value="Chemistry">Chemistry</option>
    <option value="Maths">Maths</option>
  </select>

  <!-- Backgrounds -->
  <select id="bgSelect">
    <option value="">Background</option>
    <option value="grid">Grid</option>
    <option value="lined">Lined</option>
    <option value="dots">Dots</option>
  </select>
</div>

<canvas id="board" width="1200" height="700"></canvas>

<!-- Firebase & Fabric.js -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>

<script>
/* ---------------- Firebase Setup ---------------- */
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT.firebaseapp.com",
  projectId: "YOUR_PROJECT_ID",
  storageBucket: "YOUR_PROJECT.appspot.com",
  messagingSenderId: "SENDER_ID",
  appId: "APP_ID"
};
firebase.initializeApp(firebaseConfig);
const storage = firebase.storage();
const firestore = firebase.firestore();

/* ---------------- Fabric.js Setup ---------------- */
const canvas = new fabric.Canvas('board', { isDrawingMode:true });
canvas.setBackgroundColor('#fff', canvas.renderAll.bind(canvas));

/* ---------------- Slide Management ---------------- */
let slides = [];
let currentSlide = 0;

function loadSlide(index){
  if(!slides[index]) { canvas.clear(); canvas.setBackgroundColor('#fff', canvas.renderAll.bind(canvas)); return; }
  fabric.Image.fromURL(slides[index], function(img){
    canvas.clear(); canvas.setBackgroundColor('#fff', canvas.renderAll.bind(canvas));
    canvas.add(img);
    canvas.renderAll();
  });
}
function prevSlide(){ if(currentSlide>0) currentSlide--; loadSlide(currentSlide); }
function nextSlide(){ if(currentSlide<slides.length-1) currentSlide++; loadSlide(currentSlide); }

/* ---------------- Brushes ---------------- */
function setBrush(type){
  switch(type){
    case 'normal':
      canvas.freeDrawingBrush = new fabric.PencilBrush(canvas);
      canvas.freeDrawingBrush.width = 2; canvas.freeDrawingBrush.color = '#000';
      break;
    case 'brush':
      canvas.freeDrawingBrush = new fabric.PencilBrush(canvas);
      canvas.freeDrawingBrush.width = 5; canvas.freeDrawingBrush.color = '#000';
      break;
    case 'fountain':
      canvas.freeDrawingBrush = new fabric.PencilBrush(canvas);
      canvas.freeDrawingBrush.width = 3; canvas.freeDrawingBrush.color = '#000';
      canvas.freeDrawingBrush.shadow = new fabric.Shadow({ blur:2, offsetX:1, offsetY:1, affectStroke:true });
      break;
    case 'marker':
      canvas.freeDrawingBrush = new fabric.PencilBrush(canvas);
      canvas.freeDrawingBrush.width = 10; canvas.freeDrawingBrush.color = 'rgba(0,0,255,0.3)';
      break;
    case 'highlighter':
      canvas.freeDrawingBrush = new fabric.PencilBrush(canvas);
      canvas.freeDrawingBrush.width = 15; canvas.freeDrawingBrush.color = 'rgba(255,255,0,0.4)';
      break;
  }
}

/* ---------------- Shapes ---------------- */
function addShape(shape){
  canvas.isDrawingMode=false;
  let obj;
  switch(shape){
    case 'rect': obj = new fabric.Rect({ left:50, top:50, width:100, height:60, fill:'transparent', stroke:'#000', strokeWidth:2 }); break;
    case 'circle': obj = new fabric.Circle({ left:50, top:50, radius:50, fill:'transparent', stroke:'#000', strokeWidth:2 }); break;
    case 'line': obj = new fabric.Line([50,50,200,50], { stroke:'#000', strokeWidth:2 }); break;
    case 'dottedLine': obj = new fabric.Line([50,50,200,50], { stroke:'#000', strokeWidth:2, strokeDashArray:[5,5] }); break;
    case 'triangle': obj = new fabric.Triangle({ width:80, height:80, left:50, top:50, fill:'transparent', stroke:'#000', strokeWidth:2 }); break;
  }
  canvas.add(obj);
}

/* ---------------- Upload Image ---------------- */
document.getElementById('uploadFile').addEventListener('change', function(e){
  const file = e.target.files[0]; if(!file) return;
  const reader = new FileReader();
  reader.onload = function(f){
    fabric.Image.fromURL(f.target.result, function(img){
      img.scaleToWidth(500);
      canvas.add(img);
    });
  };
  reader.readAsDataURL(file);
});

/* ---------------- Backgrounds ---------------- */
document.getElementById('bgSelect').addEventListener('change', function(){
  const val = this.value;
  if(val==='grid') canvas.setBackgroundImage('grid.png', canvas.renderAll.bind(canvas), { originX:'left', originY:'top' });
  else if(val==='lined') canvas.setBackgroundImage('lined.png', canvas.renderAll.bind(canvas), { originX:'left', originY:'top' });
  else if(val==='dots') canvas.setBackgroundImage('dots.png', canvas.renderAll.bind(canvas), { originX:'left', originY:'top' });
  else canvas.setBackgroundColor('#fff', canvas.renderAll.bind(canvas));
});

/* ---------------- Save Slide ---------------- */
async function saveSlide(){
  const classVal = document.getElementById('classSelect').value;
  const subjectVal = document.getElementById('subjectSelect').value;
  if(!classVal || !subjectVal){ alert('Select Class & Subject'); return; }

  const dataURL = canvas.toDataURL({ format:'png' });
  const fileName = `slide_${Date.now()}.png`;
  const storageRef = storage.ref().child(`${classVal}/${subjectVal}/${fileName}`);
  const res = await storageRef.putString(dataURL,'data_url');
  const url = await res.ref.getDownloadURL();

  await firestore.collection('slides').add({ class:classVal, subject:subjectVal, url:url, timestamp:Date.now() });

  slides.push(url);
  currentSlide = slides.length-1;
  alert('Slide saved!');
}

/* ---------------- Load Existing Slides ---------------- */
async function loadExistingSlides(){
  const classVal = document.getElementById('classSelect').value;
  const subjectVal = document.getElementById('subjectSelect').value;
  if(!classVal || !subjectVal) return;

  const snapshot = await firestore.collection('slides')
    .where('class','==',classVal)
    .where('subject','==',subjectVal)
    .orderBy('timestamp')
    .get();

  slides = snapshot.docs.map(doc=>doc.data().url);
  currentSlide = slides.length-1;
  loadSlide(currentSlide);
}

document.getElementById('classSelect').addEventListener('change', loadExistingSlides);
document.getElementById('subjectSelect').addEventListener('change', loadExistingSlides);
</script>
</body>
</html>
